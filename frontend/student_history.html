<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin: Student Results</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 20px;
      font-family: Arial, sans-serif;
    }
    .table {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <h2>All Student Exam Results</h2>
  <table class="table table-bordered">
    <thead class="table-dark">
      <tr>
        <th>#</th>
        <th>Student Name</th>
        <th>Email</th>
        <th>Exam Title</th>
        <th>Score</th>
        <th>Total</th>
        <th>Percentage</th>
        <th>Date</th>
      </tr>
    </thead>
    <tbody id="resultTableBody"></tbody>
  </table>

  <script>
    const token = localStorage.getItem('token');
    const role = localStorage.getItem('role');
    if (!token || role !== 'admin') {
      alert('Access denied');
      window.location.href = 'login.html';
    }

    fetch('/api/results/all', {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
    .then(res => res.json())
    .then(data => {
      const tbody = document.getElementById('resultTableBody');
      tbody.innerHTML = '';

      if (!Array.isArray(data)) {
        alert("Unexpected response. Please login again or check server.");
        return;
      }

      data.forEach((res, index) => {
        const percentage = ((res.score / res.total) * 100).toFixed(2);
        const date = new Date(res.createdAt).toLocaleString();
        tbody.innerHTML += `
          <tr>
            <td>${index + 1}</td>
            <td>${res.userId?.name || 'N/A'}</td>
            <td>${res.userId?.email || 'N/A'}</td>
            <td>${res.examId?.title || 'N/A'}</td>
            <td>${res.score}</td>
            <td>${res.total}</td>
            <td>${percentage}%</td>
            <td>${date}</td>
          </tr>
        `;
      });
    })
    .catch(err => {
      console.error("Error loading admin results:", err);
      alert("Failed to load results. Check server console or login again.");
    });
  </script>
</body>
</html>
