<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Exam</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(-45deg, #e6f0ff, #f5eaff, #eafff1, #fff5f0);
      background-size: 400% 400%;
      animation: gradientMove 12s ease infinite;
      min-height: 100vh;
      margin: 0;
      padding-bottom: 60px;
    }

    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    h2 {
      font-weight: 600;
      color: #0d6efd;
      margin-bottom: 20px;
      animation: fadeIn 0.8s ease-in-out;
    }

    #timer {
      background: #e7f1ff;
      padding: 5px 12px;
      border-radius: 10px;
      font-weight: 600;
      color: #0d6efd;
    }

    .container {
      padding-top: 30px;
    }

    .form-check {
      margin: 5px 0;
    }

    .form-check input {
      margin-right: 8px;
    }

    .btn-success {
      margin-top: 20px;
      padding: 10px 25px;
      font-weight: 500;
      border-radius: 50px;
      transition: 0.3s;
    }

    .btn-success:hover {
      transform: scale(1.05);
    }

    .toast-body {
      font-weight: 500;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>

<!-- ✅ Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="index.html">Online Exam</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto" id="nav-links"></ul>
      <ul class="navbar-nav">
        <li class="nav-item">
          <span class="navbar-text me-3" id="userNameDisplay"></span>
        </li>
        <li class="nav-item">
          <button class="btn btn-outline-danger" id="logoutBtn" onclick="logout()" style="display: none;">Logout</button>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- ✅ Toast container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  <div id="toast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastMessage">Toast message</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<!-- ✅ Exam Header & Questions -->
<div class="container">
  <h2 id="examTitle">Exam Title <span class="float-end" id="timer">00:00</span></h2>
  <div id="questionsContainer" class="mt-4"></div>
</div>

<!-- ✅ Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
function showToast(message, type = 'danger') {
  const toastEl = document.getElementById('toast');
  const toastMsg = document.getElementById('toastMessage');
  toastMsg.innerText = message;
  toastEl.className = `toast align-items-center text-bg-${type} border-0`;
  const bsToast = new bootstrap.Toast(toastEl);
  bsToast.show();
}

function logout() {
  localStorage.clear();
  window.location.href = "login.html";
}

window.onload = function () {
  const token = localStorage.getItem('token');
  const role = localStorage.getItem('role');
  const userName = localStorage.getItem('userName');

  const navLinks = document.getElementById("nav-links");
  const logoutBtn = document.getElementById("logoutBtn");
  const userNameDisplay = document.getElementById("userNameDisplay");

  if (!token) {
    showToast("Unauthorized. Please login.");
    setTimeout(() => window.location.href = "login.html", 2000);
    return;
  }

  logoutBtn.style.display = "inline-block";
  userNameDisplay.innerText = `Welcome, ${userName}`;

  if (role === 'student') {
    navLinks.innerHTML = `
      <li class="nav-item"><a class="nav-link" href="dashboard.html">Dashboard</a></li>
      <li class="nav-item"><a class="nav-link" href="result.html">Results</a></li>`;
  } else if (role === 'admin') {
    navLinks.innerHTML = `
      <li class="nav-item"><a class="nav-link" href="admin.html">Admin Panel</a></li>
      <li class="nav-item"><a class="nav-link" href="dashboard.html">All Exams</a></li>`;
  }

  loadExam();
};

let examId = new URLSearchParams(window.location.search).get('examId');
let examData = {};
let score = 0;

function loadExam() {
  const token = localStorage.getItem('token');
  
  fetch(`/api/exams/${examId}`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  })
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        showToast(data.error, "danger");
        return;
      }

      examData = data;
      document.getElementById("examTitle").innerHTML = `${examData.title} <span class="float-end" id="timer">${examData.duration}:00</span>`;
      renderQuestions(examData.questions);
      startTimer(examData.duration * 60);
    })
    .catch(() => showToast("Error loading exam", "danger"));
}

function renderQuestions(questions) {
  const container = document.getElementById('questionsContainer');
  container.innerHTML = `<form id="examForm"></form>`;
  const form = document.getElementById('examForm');

  questions.forEach((q, i) => {
    let block = `<div class="mb-4 p-3 bg-white rounded shadow-sm">
      <p><strong>${i + 1}. ${q.questionText}</strong></p>`;
    q.options.forEach((opt, idx) => {
      block += `<div class="form-check">
        <input class="form-check-input" type="radio" name="q${i}" value="${idx}" id="q${i}_${idx}">
        <label class="form-check-label" for="q${i}_${idx}">${opt}</label>
      </div>`;
    });
    block += `</div>`;
    form.innerHTML += block;
  });

  form.innerHTML += `<button class="btn btn-success" type="submit">Submit</button>`;

  form.addEventListener('submit', function (e) {
    e.preventDefault();
    const formData = new FormData(form);
    let total = questions.length;
    score = 0;

    questions.forEach((q, i) => {
      const selected = formData.get(`q${i}`);
      if (selected == q.correctAnswer) score++;
    });

    const userId = localStorage.getItem('userId');

    fetch('/api/results/submit', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('token')}` },
      body: JSON.stringify({ userId, examId, score, total })
    })
      .then(res => res.json())
      .then(() => {
        localStorage.setItem('lastScore', score);
        localStorage.setItem('lastTotal', total);
        window.location.href = 'result.html';
      })
      .catch(() => showToast("Submission failed", "danger"));
  });
}

function startTimer(seconds) {
  const timerElement = document.getElementById("timer");
  const interval = setInterval(() => {
    const m = Math.floor(seconds / 60);
    const s = seconds % 60;
    timerElement.innerText = `${m}:${s.toString().padStart(2, '0')}`;
    if (seconds-- <= 0) {
      clearInterval(interval);
      showToast("Time's up!", "warning");
      document.getElementById('examForm').requestSubmit();
    }
  }, 1000);
}
</script>

</body>
</html>
